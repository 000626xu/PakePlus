import{a as e,e as s,r as a,c as o,m as r,j as i,S as l,B as n,T as d}from"./index-aeca932e.js";import{F as u}from"./index-85dc0d3a.js";import{I as m}from"./index-d90fa46f.js";import{a as p}from"./index-801a9590.js";import"./index-d93151a5.js";import"./index-5a025839.js";import"./index-fb057fd6.js";import{P as c}from"./index-60197fbb.js";import{D as x}from"./index-a0588428.js";import{I as h}from"./index-a1eba122.js";import{u as j}from"./user-a3dc1d16.js";import{T as w}from"./PowerTreeTable-6e795c42.js";import{u as y}from"./useSetState-8e08c7f5.js";import{M as g}from"./index-6226197c.js";import{S as f}from"./SearchOutlined-fa850377.js";import{P as v}from"./PlusCircleOutlined-90803570.js";import{E as S}from"./EditOutlined-21831c3e.js";import{T}from"./ToolOutlined-4ea6ca79.js";import{S as b,C as k}from"./StopOutlined-b16a34ba.js";import"./responsiveObserve-cfbf1a72.js";import"./index-73995e0d.js";import"./EyeOutlined-f0ed5c3d.js";import"./index-5bcf51a7.js";import"./getScrollBarSize-6b2349d8.js";import"./isEqual-89fb4070.js";import"./useForceUpdate-c2b76191.js";import"./index-4a60c0a0.js";import"./ActionButton-04036752.js";import"./Portal-0dc81ff6.js";const{TextArea:I}=m,{Option:N}=l,C={labelCol:{xs:{span:24},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:19}}};function D(){document.title="角色管理";const D=e(),O=s((e=>e.app.powersCode)),P=s((e=>e.sys.powerTreeData)),[A]=u.useForm(),[L,z]=a.useState([]),[R,F]=a.useState(!1),[q,E]=y({pageNum:1,pageSize:10,total:0}),[$,V]=y({operateType:"add",nowData:null,modalShow:!1,modalLoading:!1}),[B,M]=y({title:void 0,conditions:void 0}),[Q,U]=y({treeOnOkLoading:!1,powerTreeShow:!1,powerTreeDefault:{menus:[],powers:[]}});a.useEffect((()=>{X(q),J(),W()}),[]);const J=()=>{const e=o.getAllMenusAndPowers().data;D.sys.reducerSetAllPowers(e)},X=async e=>{if(!O.includes("role:query"))return;const s={page:e.pageNum,limit:e.pageSize};F(!0);try{const a=await j.getRolesList(s);a&&200===a.code?(z(a.data),E({total:a.cont,pageNum:e.pageNum,pageSize:e.pageSize})):r.error((null==a?void 0:a.message)??t("dataFetchFailed"))}finally{F(!1)}},Y=e=>{M({conditions:e})},[Z,_]=a.useState({uuid:"",powerlist:{}}),G=(e,s)=>{V({modalShow:!0,nowData:e,operateType:s}),setTimeout((()=>{var a;if("add"===s)A.setFieldsValue({rolename:"",proxy:"",store:"",desc:"",limit:""});else{if(_({uuid:e.uuid,powerlist:{menuAndPowers:e.menuAndPowers}}),e.proxy&&"-"!==e.proxy){const s=null==(a=H.find((s=>s.label===e.proxy||s.value===e.proxy)))?void 0:a.value;ae(s)}A.setFieldsValue({rolename:e.title,proxy:"-"===e.proxy?"":e.proxy,store:"-"===e.store?"":e.store,desc:e.desc,limit:e.limit.split("/")[1]})}}))},[H,K]=a.useState([]),W=async()=>{const e=(await j.getAgents()).data.map((e=>({label:e.providername,value:e.uuid})));K(e)},[ee,se]=a.useState([]),ae=async e=>{const s=(await j.getStores({agenuuid:e})).data.map((e=>({label:e.providername,value:e.uuid})));se(s)},oe=()=>{A.setFieldsValue({rolename:"",proxy:"",store:"",desc:"",limit:""}),V({modalShow:!1})},te=()=>{U({powerTreeShow:!1})},re=[{title:"编号",dataIndex:"serial",key:"serial"},{title:"角色名称",dataIndex:"title",key:"title"},{title:"所属门店",dataIndex:"store",key:"store"},{title:"所属代理",dataIndex:"proxy",key:"proxy"},{title:"角色说明",dataIndex:"desc",key:"desc"},{title:"数量限制",dataIndex:"limit",key:"limit"},{title:"状态",dataIndex:"conditions",key:"conditions",render:e=>1===e?i.jsx("span",{style:{color:"green"},children:"启用"}):i.jsx("span",{style:{color:"red"},children:"禁用"})},{title:"操作",key:"control",width:200,render:(e,s)=>{const a=[];O.includes("role:up")&&a.push(i.jsx("span",{className:"control-btn blue",onClick:()=>G(s,"up"),children:i.jsx(d,{placement:"top",title:"编辑角色",children:i.jsx(S,{})})},"1")),O.includes("role:power")&&a.push(i.jsx("span",{className:"control-btn blue",onClick:()=>(e=>{const s=e.menuAndPowers.map((e=>e.menuId)),a=e.menuAndPowers.reduce(((e,s)=>[...e,...s.powers]),[]);V({nowData:e}),U({powerTreeShow:!0,powerTreeDefault:{menus:s,powers:a}})})(s),children:i.jsx(d,{placement:"top",title:"分配权限",children:i.jsx(T,{})})},"2")),O.includes("role:del")&&a.push(i.jsx(c,{title:1===s.status?"确定禁用吗？":"确定启用吗？",onConfirm:()=>(async e=>{F(!0);try{let s;s=1===e.status?await j.closeRole({uuid:e.uuid}):await j.openRole({uuid:e.uuid}),s&&200===s.code?(r.success("删除成功"),X(q)):r.error((null==s?void 0:s.message)??"操作失败")}finally{F(!1)}})(s),okText:"确定",cancelText:"取消",children:i.jsx("span",{className:"control-btn red",children:i.jsx(d,{placement:"top",title:1===s.status?"禁用":"启用",children:1===s.status?i.jsx(b,{}):i.jsx(k,{style:{color:"green"}})})})},"3"));const o=[];return a.forEach(((e,s)=>{s&&o.push(i.jsx(x,{type:"vertical"},`line${s}`)),o.push(e)})),o}}],ie=a.useMemo((()=>L.map(((e,s)=>({key:e.id,uuid:e.uuid,serial:s+1+(q.pageNum-1)*q.pageSize,title:e.rolename,store:e.providerinfor?e.providerinfor.providername:"-",storeId:e.providerinfor?e.providerinfor.uuid:"-",proxy:e.agentinfor?e.agentinfor.providername:"-",proxyId:e.agentinfor?e.agentinfor.uuid:"-",limit:`${e.usernum}/${e.maxvolumne}`,maxLimit:e.maxvolumne,usedLimit:e.usernum,desc:e.roledetail?e.roledetail.remarks:"-",sorts:1,conditions:e.deletedtime?0:1,status:e.deletedtime?0:1,control:1,menuAndPowers:e.roledetail&&e.roledetail.powerlist?e.roledetail.powerlist.menuAndPowers:[]})))),[q,L]);return i.jsxs("div",{className:"role-box",children:[i.jsxs("div",{className:"g-search",children:[O.includes("role:query")&&i.jsxs("ul",{className:"search-ul",children:[i.jsxs("li",{className:"search-item",children:[i.jsx("span",{className:"item-lable",children:"门店名称:"}),i.jsx(m,{placeholder:"请输门店名称",onChange:e=>{e.target.value.length<20&&M({title:e.target.value})},value:B.title})]}),i.jsxs("li",{className:"search-item",children:[i.jsx("span",{className:"item-lable",children:"门店类型:"}),i.jsxs(l,{placeholder:"请选择状态",allowClear:!0,style:{width:"100px"},onChange:Y,value:B.conditions,children:[i.jsx(N,{value:1,children:"启用"}),i.jsx(N,{value:-1,children:"禁用"})]})]}),i.jsxs("li",{className:"search-item",children:[i.jsx("span",{className:"item-lable",style:{width:"60px"},children:"代理:"}),i.jsxs(l,{placeholder:"请选择状态",allowClear:!0,style:{width:"100px"},onChange:Y,value:B.conditions,children:[i.jsx(N,{value:1,children:"启用"}),i.jsx(N,{value:-1,children:"禁用"})]})]}),i.jsx("li",{children:i.jsx(n,{type:"primary",icon:i.jsx(f,{}),onClick:()=>{X(q)},children:"搜索"})})]}),i.jsx("ul",{className:"search-func",children:O.includes("role:add")&&i.jsx("li",{children:i.jsx(n,{type:"primary",icon:i.jsx(v,{}),disabled:!O.includes("role:add"),onClick:()=>G(null,"add"),children:"新增角色"})})})]}),i.jsx("div",{className:"diy-table",children:i.jsx(p,{columns:re,loading:R,dataSource:ie,pagination:{total:q.total,current:q.pageNum,pageSize:q.pageSize,showQuickJumper:!1,showTotal:e=>`共 ${e} 条数据`,onChange:(e,s)=>((e,s)=>{X({pageNum:e,pageSize:s||q.pageSize})})(e,s)}})}),i.jsx(g,{title:{add:"新增角色",up:"编辑角色",see:"查看"}[$.operateType],open:$.modalShow,cancelText:"取消",okText:"确认",onOk:()=>(async()=>{var e,s;if("see"!==$.operateType)try{const a=await A.validateFields();if(V({modalLoading:!0}),"add"===$.operateType){const e={rolename:a.rolename,useruuid:a.proxy,provideruuid:a.store,maxvolumne:a.limit,powerlist:{menuAndPowers:[{menuId:0,powers:[]}]},remarks:a.desc};try{const s=await j.addRole(e);s&&200===s.code&&(r.success("添加成功"),X(q),oe())}finally{V({modalLoading:!1})}}else{const o=null==(e=ee.find((e=>e.label===a.store||e.value===a.store)))?void 0:e.value,t=null==(s=H.find((e=>e.label===a.proxy||e.value===a.proxy)))?void 0:s.value,i={uuid:Z.uuid,rolename:a.rolename,useruuid:t,provideruuid:o,maxvolumne:a.limit,powerlist:Z.powerlist,remarks:a.desc};try{const e=await j.updateRole(i);e&&200===e.code&&(r.success("修改成功"),X(q),oe())}finally{V({modalLoading:!1})}}}catch{}else oe()})(),onCancel:()=>oe(),confirmLoading:$.modalLoading,children:i.jsxs(u,{form:A,initialValues:{formConditions:1},children:[i.jsx(u.Item,{label:"角色名称",name:"rolename",...C,rules:[{required:!0,whitespace:!0,message:"请输入角色名称"},{max:20,message:"最多输入20位字符"}],children:i.jsx(m,{placeholder:"请输入角色名",disabled:"see"===$.operateType})}),i.jsx(u.Item,{label:"所属代理",name:"proxy",...C,rules:[{required:!0,message:"请选择所属代理"}],children:i.jsx(l,{disabled:"see"===$.operateType,options:H,onSelect:ae,placeholder:"请选择所属代理"})}),i.jsx(u.Item,{label:"所属门店",name:"store",...C,rules:[{required:!0,message:"请选择所属门店"}],children:i.jsx(l,{disabled:"see"===$.operateType,options:ee,placeholder:"请选择所属门店"})}),i.jsx(u.Item,{label:"角色描述",name:"desc",...C,rules:[{max:200,message:"最多输入200个字符"},{required:!0,message:"请输入角色描述"}],children:i.jsx(I,{rows:4,disabled:"see"===$.operateType,autoSize:{minRows:2,maxRows:6}})}),i.jsx(u.Item,{label:"数量限制",name:"limit",...C,rules:[{required:!0,message:"请输入数量限制"}],children:i.jsx(h,{min:0,max:99,style:{width:"100%"},disabled:"see"===$.operateType})})]})}),i.jsx(w,{title:$.nowData?`权限：${$.nowData.title}`:"分配权限",data:P,defaultChecked:Q.powerTreeDefault,loading:Q.treeOnOkLoading,modalShow:Q.powerTreeShow,onOk:async e=>{var s;if(!(null==(s=null==$?void 0:$.nowData)?void 0:s.uuid))return void r.error("该数据没有ID");const a={id:$.nowData.uuid,menus:e.menus,powers:e.powers};U({treeOnOkLoading:!0});try{const e=o.setPowersByRoleId(a),s={uuid:$.nowData.uuid,rolename:$.nowData.title,useruuid:$.nowData.proxyId,provideruuid:$.nowData.storeId,maxvolumne:$.nowData.maxLimit,powerlist:{menuAndPowers:e.data},remarks:$.nowData.desc},i=await j.updateRole(s);i&&200===i.code?(r.success(t("operationSuccessful")),X(q),te()):r.error((null==i?void 0:i.message)??"权限分配失败")}finally{U({treeOnOkLoading:!1})}},onClose:te})]})}export{D as default};
