import{b as e,a as s,e as a,r as o,c as i,m as t,j as r,T as l,B as n}from"./index-aeca932e.js";import{F as d}from"./index-85dc0d3a.js";import{I as u}from"./index-d90fa46f.js";import{a as m}from"./index-801a9590.js";import"./index-d93151a5.js";import"./index-5a025839.js";import"./index-fb057fd6.js";import{P as p}from"./index-60197fbb.js";import{D as c}from"./index-a0588428.js";import{I as x}from"./index-a1eba122.js";import{u as w}from"./user-a3dc1d16.js";import{T as y}from"./PowerTreeTable-6e795c42.js";import{u as f}from"./useSetState-8e08c7f5.js";import{E as j}from"./EditOutlined-21831c3e.js";import{S as g,C as v}from"./StopOutlined-b16a34ba.js";import{P as h}from"./PlusCircleOutlined-90803570.js";import{M as S}from"./index-6226197c.js";import{T as b}from"./ToolOutlined-4ea6ca79.js";import"./responsiveObserve-cfbf1a72.js";import"./index-73995e0d.js";import"./EyeOutlined-f0ed5c3d.js";import"./index-5bcf51a7.js";import"./getScrollBarSize-6b2349d8.js";import"./isEqual-89fb4070.js";import"./useForceUpdate-c2b76191.js";import"./index-4a60c0a0.js";import"./ActionButton-04036752.js";import"./Portal-0dc81ff6.js";const{TextArea:T}=u,k={labelCol:{xs:{span:24},sm:{span:6}},wrapperCol:{xs:{span:24},sm:{span:19}}};function D(){const{t:D}=e();document.title="HADO CRM";const N=s(),I=a((e=>e.app.powersCode)),O=a((e=>e.sys.powerTreeData)),P=a((e=>e.app.userinfo)),[A]=d.useForm(),[L,C]=o.useState([]),[R,z]=o.useState(!1),[E,F]=f({pageNum:1,pageSize:10,total:0}),[q,B]=f({operateType:"add",nowData:null,modalShow:!1,modalLoading:!1});f({title:void 0,conditions:void 0});const[V,$]=f({treeOnOkLoading:!1,powerTreeShow:!1,powerTreeDefault:{menus:[],powers:[]}});o.useEffect((()=>{M(E),J(),Z()}),[]);const J=()=>{const e=i.getAllMenusAndPowers().data.filter((e=>1!==e.id&&6!==e.id));N.sys.reducerSetAllPowers(e)},M=async e=>{if(!I.includes("role:query"))return;const s={page:e.pageNum,limit:e.pageSize};z(!0);try{const a=await w.getRolesList(s);a&&200===a.code?(C(a.data),F({total:a.cont,pageNum:e.pageNum,pageSize:e.pageSize})):t.error((null==a?void 0:a.message)??D("dataFetchFailed"))}finally{z(!1)}},[Q,U]=o.useState({uuid:"",powerlist:{}}),H=(e,s)=>{B({modalShow:!0,nowData:e,operateType:s}),setTimeout((()=>{var a;if("add"===s)A.setFieldsValue({rolename:"",proxy:"",store:"",desc:"",limit:""});else{if(U({uuid:e.uuid,powerlist:{menuAndPowers:e.menuAndPowers}}),e.proxy&&"-"!==e.proxy){const s=null==(a=X.find((s=>s.label===e.proxy||s.value===e.proxy)))?void 0:a.value;K(s)}A.setFieldsValue({rolename:e.title,proxy:"-"===e.proxy?"":e.proxyId,store:"-"===e.store?"":e.storeId,desc:e.desc,limit:e.limit.split("/")[1]})}}))},[X,Y]=o.useState([]),Z=async()=>{var e;const s=null==(e=(await w.getAgents()).data)?void 0:e.map((e=>({label:e.providername,value:e.uuid})));Y(s)},[_,G]=o.useState([]),K=async e=>{var s;const a=null==(s=(await w.getStores({agenuuid:e})).data)?void 0:s.map((e=>({label:e.providername,value:e.uuid})));G(a)},W=()=>{A.setFieldsValue({rolename:"",proxy:"",store:"",desc:"",limit:""}),B({modalShow:!1})},ee=()=>{$({powerTreeShow:!1})},se=[{title:D("number"),dataIndex:"serial",key:"serial"},{title:D("roleName"),dataIndex:"title",key:"title"},{title:D("roleDescription"),dataIndex:"desc",key:"desc"},{title:D("quantityLimit"),dataIndex:"limit",key:"limit"},{title:D("status"),dataIndex:"conditions",key:"conditions",render:e=>1===e?r.jsx("span",{style:{color:"green"},children:D("enable")}):r.jsx("span",{style:{color:"red"},children:D("disable")})},{title:D("action"),key:"control",width:200,render:(e,s)=>{const a=[];P.userBasicInfo,I.includes("role:up")&&"admin"!==s.title&&a.push(r.jsx("span",{className:"control-btn blue",onClick:()=>H(s,"up"),children:r.jsx(l,{placement:"top",title:D("edit"),children:r.jsx(j,{})})},"1")),I.includes("role:power")&&"admin"!==s.title&&a.push(r.jsx("span",{className:"control-btn blue",onClick:()=>(e=>{var s,a;const o=null==(s=e.menuAndPowers)?void 0:s.map((e=>e.menuId)),i=null==(a=e.menuAndPowers)?void 0:a.reduce(((e,s)=>[...e,...s.powers]),[]);B({nowData:e}),$({powerTreeShow:!0,powerTreeDefault:{menus:o,powers:i}})})(s),children:r.jsx(l,{placement:"top",title:D("assignPermissions"),children:r.jsx(b,{})})},"2")),I.includes("role:del")&&"admin"!==s.title&&a.push(r.jsx(p,{title:1===s.status?D("disable"):D("enable"),onConfirm:()=>(async e=>{z(!0);try{let s;s=1===e.status?await w.closeRole({uuid:e.uuid}):await w.openRole({uuid:e.uuid}),s&&200===s.code?(t.success("success"),M(E)):t.error((null==s?void 0:s.message)??"操作失败")}finally{z(!1)}})(s),cancelText:D("cancel"),okText:D("confirm"),children:r.jsx("span",{className:"control-btn red",children:r.jsx(l,{placement:"top",title:1===s.status?D("disable"):D("enable"),children:1===s.status?r.jsx(g,{}):r.jsx(v,{style:{color:"green"}})})})},"3"));const o=[];return a.forEach(((e,s)=>{s&&o.push(r.jsx(c,{type:"vertical"},`line${s}`)),o.push(e)})),o}}],ae=o.useMemo((()=>null==L?void 0:L.map(((e,s)=>({key:e.id,uuid:e.uuid,serial:s+1+(E.pageNum-1)*E.pageSize,title:e.rolename,store:e.providerinfor?e.providerinfor.providername:"-",storeId:e.providerinfor?e.providerinfor.uuid:"-",proxy:e.agentinfor?e.agentinfor.providername:"-",proxyId:e.agentinfor?e.agentinfor.uuid:"-",limit:`${e.usernum}/${e.maxvolumne}`,maxLimit:e.maxvolumne,usedLimit:e.usernum,desc:e.roledetail?e.roledetail.remarks:"-",sorts:1,conditions:e.deletedtime?0:1,status:e.deletedtime?0:1,control:1,menuAndPowers:e.roledetail&&e.roledetail.powerlist?e.roledetail.powerlist.menuAndPowers:[]})))),[E,L]),oe={emptyText:D("noDataAvailable")};return r.jsxs("div",{className:"role-box",children:[r.jsx("div",{className:"role-search",children:r.jsx("ul",{className:"search-func",children:I.includes("role:add")&&r.jsx("li",{children:r.jsx(n,{type:"primary",icon:r.jsx(h,{}),disabled:!I.includes("role:add"),onClick:()=>H(null,"add"),children:D("addNewRole")})})})}),r.jsx("div",{className:"diy-table",children:r.jsx(m,{columns:se,loading:R,locale:oe,dataSource:ae,pagination:{total:E.total,current:E.pageNum,pageSize:E.pageSize,showQuickJumper:!1,showTotal:e=>D("dataNumber",{count:e}),onChange:(e,s)=>((e,s)=>{M({pageNum:e,pageSize:s||E.pageSize})})(e,s)}})}),r.jsx(S,{title:{add:D("addNewRole"),up:D("editRole"),see:D("view")}[q.operateType],open:q.modalShow,cancelText:D("cancel"),okText:D("confirm"),onOk:()=>(async()=>{var e,s;if("see"!==q.operateType)try{const a=await A.validateFields();if(B({modalLoading:!0}),"add"===q.operateType){let e={menuAndPowers:[{menuId:0,powers:[]}]};const s={rolename:a.rolename,useruuid:a.proxy,provideruuid:a.store,maxvolumne:a.limit,powerlist:JSON.stringify(e),remarks:a.desc};try{const e=await w.addRole(s);e&&200===e.code&&(t.success("success"),M(E),W())}finally{B({modalLoading:!1})}}else{const o=null==(e=_.find((e=>e.label===a.store||e.value===a.store)))?void 0:e.value,i=null==(s=X.find((e=>e.label===a.proxy||e.value===a.proxy)))?void 0:s.value,r={uuid:Q.uuid,rolename:a.rolename,useruuid:i,provideruuid:o,maxvolumne:a.limit,powerlist:JSON.stringify(Q.powerlist),remarks:a.desc};try{const e=await w.updateRole(r);e&&200===e.code&&(t.success("success"),M(E),W())}finally{B({modalLoading:!1})}}}catch{}else W()})(),onCancel:()=>W(),confirmLoading:q.modalLoading,children:r.jsxs(d,{form:A,initialValues:{formConditions:1},children:[r.jsx(d.Item,{label:D("roleName"),name:"rolename",...k,rules:[{required:!0,whitespace:!0,message:D("pleaseEnter")},{max:20,message:"最多输入20位字符"}],children:r.jsx(u,{placeholder:D("pleaseEnter"),disabled:"see"===q.operateType})}),r.jsx(d.Item,{label:D("roleDescription"),name:"desc",...k,rules:[{max:200,message:"最多输入200个字符"},{required:!0,message:D("pleaseEnter")}],children:r.jsx(T,{rows:4,disabled:"see"===q.operateType,autoSize:{minRows:2,maxRows:6}})}),r.jsx(d.Item,{label:D("quantityLimit"),name:"limit",...k,rules:[{required:!0,message:D("pleaseEnter")}],children:r.jsx(x,{min:0,max:99,style:{width:"100%"},disabled:"see"===q.operateType})})]})}),r.jsx(y,{title:q.nowData?D("permissions")+`：${q.nowData.title}`:D("assignPermissions"),data:O,defaultChecked:V.powerTreeDefault,loading:V.treeOnOkLoading,modalShow:V.powerTreeShow,onOk:async e=>{var s;if(!(null==(s=null==q?void 0:q.nowData)?void 0:s.uuid))return void t.error("该数据没有ID");const a={id:q.nowData.uuid,menus:e.menus,powers:e.powers};$({treeOnOkLoading:!0});try{let e={menuAndPowers:i.setPowersByRoleId(a).data};const s={uuid:q.nowData.uuid,rolename:q.nowData.title,useruuid:q.nowData.proxyId,provideruuid:q.nowData.storeId,maxvolumne:q.nowData.maxLimit,powerlist:JSON.stringify(e),remarks:q.nowData.desc},o=await w.updateRole(s);o&&200===o.code?(t.success(D("operationSuccessful")),M(E),ee()):t.error((null==o?void 0:o.message)??"权限分配失败")}finally{$({treeOnOkLoading:!1})}},onClose:ee})]})}export{D as default};
