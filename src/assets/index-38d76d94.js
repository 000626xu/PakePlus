import{a as e,e as s,r as o,l as t,j as i,S as a,m as r,T as l,f as n}from"./index-aeca932e.js";import{T as d,a as m}from"./index-801a9590.js";import{C as c}from"./index-d93151a5.js";import{I as u}from"./index-d90fa46f.js";import"./index-5a025839.js";import"./index-fb057fd6.js";import{P as p}from"./index-60197fbb.js";import{F as x}from"./index-85dc0d3a.js";import{I as j}from"./index-a1eba122.js";import{D as f}from"./index-a0588428.js";import{u as h}from"./useSetState-8e08c7f5.js";import{u as y}from"./useMount-64f23307.js";import{M as w}from"./index-6226197c.js";import{E as g}from"./EyeOutlined-d33bc3ff.js";import{T as v}from"./ToolOutlined-4ea6ca79.js";import{D as b}from"./DeleteOutlined-c2326a92.js";import"./index-5bcf51a7.js";import"./getScrollBarSize-6b2349d8.js";import"./isEqual-89fb4070.js";import"./useForceUpdate-c2b76191.js";import"./index-4a60c0a0.js";import"./index-73995e0d.js";import"./EyeOutlined-f0ed5c3d.js";import"./responsiveObserve-cfbf1a72.js";import"./ActionButton-04036752.js";import"./Portal-0dc81ff6.js";import"./DeleteOutlined-6b999003.js";const{Option:T}=a,{TextArea:C}=u,I={labelCol:{xs:{span:24},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:19}}};function S(){var S;document.title="HADO CRM";const D=e(),k=s((e=>e.app.powersCode)),P=s((e=>e.sys.roles)),A=s((e=>e.app.userinfo)),[N]=x.useForm(),[O,M]=o.useState([]),[R,q]=o.useState(!1),[E,F]=h({operateType:"add",nowData:null,modalShow:!1,modalLoading:!1}),[L,$]=o.useState([]),[U,B]=o.useState({});y((()=>{0===A.menus.length&&D.sys.getMenus(),D.sys.getAllRoles(),V()}));const V=async(e=null)=>{if(!k.includes("power:query"))return;q(!0);const s={menuId:Number(e)||null};try{const e=await D.sys.getPowerDataByMenuId(s);e&&200===e.status&&M(e.data)}finally{q(!1)}},z=o.useCallback(((e,s)=>{let o;return o=e?s.filter((s=>s.parent===e.id)):s.filter((e=>!e.parent)),o.forEach((e=>e.children=z(e,s))),o.length?o:void 0}),[]),Q=o.useCallback((e=>{const s=[];for(let o=0;o<e.length;o++){const t={...e[o]};t.children&&(t.children=Q(t.children));const i={...t,key:t.id};s.push(i)}return s}),[]),G=(e,s)=>{F({modalShow:!0,nowData:e,operateType:s}),$(e&&e.id?P.filter((s=>{var o;const t=null==(o=s.menuAndPowers)?void 0:o.find((s=>s.menuId===e.menu));return!!t&&t.powers.includes(e.id)})).map((e=>e.id)):[]),setTimeout((()=>{"add"===s?N.resetFields():N.setFieldsValue({formConditions:null==e?void 0:e.conditions,formDesc:null==e?void 0:e.desc,formCode:null==e?void 0:e.code,formSorts:null==e?void 0:e.sorts,formTitle:null==e?void 0:e.title})}))},H=()=>{F({modalShow:!1})},J=(e,s)=>{const o=P.map((o=>{const t=new Set(o.menuAndPowers.reduce(((e,s)=>[...e,...s.powers]),[]));return s.includes(o.id)?t.add(e):t.delete(e),{id:o.id,menus:o.menuAndPowers.map((e=>e.menuId)),powers:Array.from(t)}}));D.sys.setPowersByRoleIds(o)},X=o.useMemo((()=>{const e=t.cloneDeep(A.menus),s=Q(e);return s.sort(((e,s)=>e.sorts-s.sorts)),z(null,s)||[]}),[A.menus,z]),Y=[{title:"序号",dataIndex:"serial",key:"serial"},{title:"权限名称",dataIndex:"title",key:"title"},{title:"Code",dataIndex:"code",key:"code"},{title:"描述",dataIndex:"desc",key:"desc"},{title:"状态",dataIndex:"conditions",key:"conditions",render:e=>1===e?i.jsx("span",{style:{color:"green"},children:"启用"}):i.jsx("span",{style:{color:"red"},children:"禁用"})},{title:"操作",key:"control",width:120,render:(e,s)=>{const o=[];k.includes("power:query")&&o.push(i.jsx("span",{className:"control-btn green",onClick:()=>G(s,"see"),children:i.jsx(l,{placement:"top",title:"查看",children:i.jsx(g,{})})},"0")),k.includes("power:up")&&o.push(i.jsx("span",{className:"control-btn blue",onClick:()=>G(s,"up"),children:i.jsx(l,{placement:"top",title:"修改",children:i.jsx(v,{})})},"1")),k.includes("power:del")&&o.push(i.jsx(p,{title:"确定删除吗?",okText:"确定",cancelText:"取消",onConfirm:()=>(async e=>{const s={id:e.id};q(!0);const o=await D.sys.delPower(s);o&&200===o.status?(V(U.id),D.app.updateUserInfo(null),r.success(n("operationSuccessful"))):r.error((null==o?void 0:o.message)??"操作失败")})(s),children:i.jsx("span",{className:"control-btn red",children:i.jsx(l,{placement:"top",title:"删除",children:i.jsx(b,{})})})},"2"));const t=[];return o.forEach(((e,s)=>{s&&t.push(i.jsx(f,{type:"vertical"},`line${s}`)),t.push(e)})),t}}],Z=o.useMemo((()=>O.map(((e,s)=>({key:s,id:e.id,menu:e.menu,title:e.title,code:e.code,desc:e.desc,sorts:e.sorts,conditions:e.conditions,serial:s+1,control:e.id})))),[O]),_=o.useMemo((()=>P.map((e=>({label:e.title,value:e.id})))),[P]);return i.jsxs("div",{className:"page-power-admin",children:[i.jsxs("div",{className:"l",children:[i.jsx("div",{className:"title",children:"目录结构"}),i.jsx("div",{children:i.jsx(d,{onSelect:(e,s)=>{s.selected?(V(e[0]),B({title:s.node.title,id:s.node.id})):(B({}),M([]))},treeData:X})})]}),i.jsx("div",{className:"r",children:i.jsx(m,{className:"diy-table",columns:Y,loading:R,dataSource:Z,pagination:{showQuickJumper:!0,showTotal:e=>`共 ${e} 条数据`}})}),i.jsx(w,{title:`${{add:"新增",up:"修改",see:"查看"}[E.operateType]}权限: ${U.title}->${(null==(S=E.nowData)?void 0:S.title)??""}`,open:E.modalShow,onOk:async()=>{var e;if("see"!==E.operateType)try{const s=await N.validateFields(),o={title:s.formTitle,code:s.formCode,menu:U.id||0,sorts:s.formSorts,desc:s.formDesc,conditions:s.formConditions};if(F({modalLoading:!0}),"add"===E.operateType)try{const e=await D.sys.addPower(o);e&&200===e.status?(r.success("添加成功"),V(U.id),H(),await J(e.data.id,L),D.app.updateUserInfo(null),D.sys.getAllRoles()):r.error("添加失败")}finally{F({modalLoading:!1})}else try{if(!(null==(e=null==E?void 0:E.nowData)?void 0:e.id))return void r.error("该数据没有ID");o.id=E.nowData.id;const s=await D.sys.upPower(o);s&&200===s.status?(r.success("修改成功"),V(U.id),H(),await J(o.id,L),D.sys.getAllRoles(),D.app.updateUserInfo(null)):r.error("修改失败")}finally{F({modalLoading:!1})}}catch{}else H()},onCancel:H,confirmLoading:E.modalLoading,children:i.jsxs(x,{form:N,initialValues:{formConditions:1},children:[i.jsx(x.Item,{label:"权限名",name:"formTitle",...I,rules:[{required:!0,whitespace:!0,message:"必填"},{max:12,message:"最多输入12位字符"}],children:i.jsx(u,{placeholder:"请输入权限名",disabled:"see"===E.operateType})}),i.jsx(x.Item,{label:"Code",name:"formCode",...I,rules:[{required:!0,whitespace:!0,message:"必填"},{max:12,message:"最多输入12位字符"}],children:i.jsx(u,{placeholder:"请输入权限Code",disabled:"see"===E.operateType})}),i.jsx(x.Item,{label:"描述",name:"formDesc",...I,rules:[{max:100,message:"最多输入100位字符"}],children:i.jsx(C,{rows:4,disabled:"see"===E.operateType,autoSize:{minRows:2,maxRows:6}})}),i.jsx(x.Item,{label:"排序",name:"formSorts",...I,rules:[{required:!0,message:"请输入排序号"}],children:i.jsx(j,{min:0,max:99999,style:{width:"100%"},disabled:"see"===E.operateType})}),i.jsx(x.Item,{label:"状态",name:"formConditions",...I,rules:[{required:!0,message:"请选择状态"}],children:i.jsxs(a,{disabled:"see"===E.operateType,children:[i.jsx(T,{value:1,children:"启用"},1),i.jsx(T,{value:-1,children:"禁用"},-1)]})}),i.jsx(x.Item,{label:"赋予",...I,children:i.jsx(c.Group,{disabled:"see"===E.operateType,options:_,value:L,onChange:e=>$(e)})})]})})]})}export{S as default};
